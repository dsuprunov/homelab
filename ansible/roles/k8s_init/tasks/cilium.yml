---
- name: cilium
  block:
    - name: cilium | create config directory
      ansible.builtin.file:
        path: /etc/kubernetes/cilium
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: cilium | copy values
      ansible.builtin.copy:
        src: cilium-values.yaml
        dest: /etc/kubernetes/cilium/values.yaml
        owner: root
        group: root
        mode: "0644"

    - name: cilium | add helm repo
      kubernetes.core.helm_repository:
        name: cilium
        repo_url: https://helm.cilium.io
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

    - name: cilium | deploy chart
      kubernetes.core.helm:
        name: cilium
        chart_ref: cilium/cilium
        chart_version: "{{ cilium_version }}"
        release_namespace: kube-system
        create_namespace: false
        wait: true
        values_files:
          - /etc/kubernetes/cilium/values.yaml
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

    - name: cilium | wait for pods ready
      ansible.builtin.command: >
        kubectl wait --for=condition=ready pod
          -l k8s-app=cilium
          -n kube-system
          --timeout=300s
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      changed_when: false