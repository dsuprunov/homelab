---
- name: flux instance
  block:
    - name: flux instance | wait for CRD
      ansible.builtin.command: >
        kubectl get crd fluxinstances.fluxcd.controlplane.io
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: fluxinstance_crd
      changed_when: false
      ignore_errors: true
      retries: 120
      delay: 5
      until: fluxinstance_crd.rc == 0

    - name: flux instance | create manifests directory
      ansible.builtin.file:
        path: /etc/kubernetes/flux
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: flux instance | copy manifest
      ansible.builtin.copy:
        src: flux-instance.yaml
        dest: /etc/kubernetes/flux/instance.yaml
        owner: root
        group: root
        mode: "0644"

    - name: flux instance | apply manifest
      ansible.builtin.command: kubectl apply -f /etc/kubernetes/flux/instance.yaml
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: fluxinstance_apply
      changed_when: "'configured' in fluxinstance_apply.stdout or 'created' in fluxinstance_apply.stdout"

    - name: flux instance | wait for ready
      ansible.builtin.command: >
        kubectl -n flux-system wait fluxinstance/flux --for=condition=Ready --timeout=10m
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      changed_when: false
